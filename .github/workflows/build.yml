name: Build PyNES Emulator

on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [main, dev]
  release:
    types: [published]
  workflow_dispatch: {}

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [windows-latest] # ubuntu-latest, macos-latest # Temporarily disabled on linux and macOS due to build issues
        python-version: ["3.14.0"]

    defaults:
      run:
        shell: bash

    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true
          cache-dependency-glob: "requirements.txt"

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            app/target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('app/**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Get pip cache dir
        id: pip-cache-dir
        working-directory: app
        run: |
          echo "dir=$(uv cache dir)" >> $GITHUB_OUTPUT

      - name: Cache pip packages
        id: pip-cache
        uses: actions/cache@v4
        with:
          path: ${{ steps.pip-cache-dir.outputs.dir }}
          key: ${{ runner.os }}-pip-${{ matrix.python-version }}-${{ hashFiles('app/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-${{ matrix.python-version }}-
            ${{ runner.os }}-pip-

      - name: Cache PyInstaller
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pyinstaller
            ~/AppData/Local/pyinstaller
            ~/Library/Caches/pyinstaller
          key: ${{ runner.os }}-pyinstaller-${{ matrix.python-version }}-${{ hashFiles('pynes.spec') }}
          restore-keys: |
            ${{ runner.os }}-pyinstaller-${{ matrix.python-version }}-
            ${{ runner.os }}-pyinstaller-

      - name: Cache UPX
        id: upx-cache
        uses: actions/cache@v4
        with:
          path: |
            upx-*
            ~/.local/bin/upx
            /usr/local/bin/upx
          key: ${{ runner.os }}-upx-5.0.2
          restore-keys: |
            ${{ runner.os }}-upx-

      - name: Cache build artifacts
        uses: actions/cache@v4
        with:
          path: |
            build/
            *.so
            *.pyd
          key: ${{ runner.os }}-build-${{ matrix.python-version }}-${{ hashFiles('setup.py') }}
          restore-keys: |
            ${{ runner.os }}-build-${{ matrix.python-version }}-
            ${{ runner.os }}-build-

      - name: Install OS dependencies
        run: |
          if [[ "${{ matrix.os }}" == "ubuntu-latest" ]]; then
            sudo apt-get update
            sudo apt-get install -y libgl1 libglib2.0-0 libxrender1 libgomp1
          elif [[ "${{ matrix.os }}" == "macos-latest" ]]; then
            brew install libomp
          fi

      - name: Install UPX
        id: upx
        run: |
          if [[ "${{ matrix.os }}" == "ubuntu-latest" ]]; then
            sudo apt-get install -y upx
            echo "upx_path=$(command -v upx)" >> $GITHUB_OUTPUT

          elif [[ "${{ matrix.os }}" == "macos-latest" ]]; then
            brew install upx
            echo "upx_path=$(command -v upx)" >> $GITHUB_OUTPUT

          elif [[ "${{ matrix.os }}" == "windows-latest" ]]; then
            if ! winget install --id=UPX.UPX -e --accept-source-agreements --accept-package-agreements --silent; then
              echo "Winget install failed, attempting direct download..."
              curl -L -o upx.zip https://github.com/upx/upx/releases/download/v5.0.2/upx-5.0.2-win64.zip
              unzip -q upx.zip
              upx_dir="$(pwd)/upx-5.0.2-win64"
              echo "upx_path=$upx_dir/upx.exe" >> $GITHUB_OUTPUT
            else
              userprofile_win="$USERPROFILE"
              userprofile=$(cygpath "$userprofile_win" 2>/dev/null || echo "$userprofile_win")
              upx_link_path="$userprofile/AppData/Local/Microsoft/WinGet/Links"
              upx_exe="$upx_link_path/upx.exe"
              if [[ -f "$upx_exe" ]]; then
                echo "UPX found at $upx_exe"
                echo "upx_path=$upx_exe" >> $GITHUB_OUTPUT
              else
                echo "upx_path=" >> $GITHUB_OUTPUT
              fi
            fi
          fi

      - name: Install Python dependencies
        run: |
          uv pip install --system --upgrade pip
          uv pip install --system --upgrade -r requirements.txt
          uv pip install --system --upgrade git+https://github.com/pyinstaller/pyinstaller.git

      - name: Build Extensions
        id: build_extensions
        run: python setup.py build_ext --inplace

      - name: Build PyNES
        id: build
        run: |
          if [[ -n "${{ steps.upx.outputs.upx_path }}" ]]; then
            upx_dir="$(dirname "${{ steps.upx.outputs.upx_path }}")"
            echo "Using UPX from: $upx_dir"
            pyinstaller pynes.spec --clean --noconfirm --upx-dir "$upx_dir"
          else
            echo "UPX not found, building without compression"
            pyinstaller pynes.spec --clean --noconfirm
          fi
          echo "build_success=true" >> $GITHUB_OUTPUT

      - name: Verify Build Output
        run: |
          if [[ "${{ matrix.os }}" == "windows-latest" ]]; then
            test -f dist/pynes.exe || exit 1
          else
            test -f dist/pynes || exit 1
          fi

      - name: Prepare Upload Directory
        run: |
          mkdir -p upload
          if [[ "${{ matrix.os }}" == "windows-latest" ]]; then
            cp dist/pynes.exe upload/
          else
            cp dist/pynes upload/
          fi
          cp app/icon.ico upload/ 2>/dev/null || true
          cp -r assets/* upload/ 2>/dev/null || true

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        if: steps.build.outputs.build_success == 'true'
        with:
          name: pynes-${{ matrix.os }}-py${{ matrix.python-version }}
          path: upload/
          retention-days: 90
