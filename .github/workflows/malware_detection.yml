name: "Malware Detection"

on:
  push:
    branches: [ main, dev ]
  pull_request:
    branches: [ main, dev ]
  release:
    types: [ published ]
  workflow_dispatch: {}

jobs:
  detect:
    runs-on: windows-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for comprehensive scanning

      - name: Install ClamAV
        run: |
          choco install clamav -y
          refreshenv
          $env:Path += ";C:\Program Files\ClamAV"
          where freshclam
          where clamscan
        shell: powershell

      - name: Update virus definitions
        run: |
          $maxRetries = 3
          $retryCount = 0
          $success = $false
          
          while (-not $success -and $retryCount -lt $maxRetries) {
            try {
              freshclam
              $success = $true
              Write-Host "Virus definitions updated successfully"
            }
            catch {
              $retryCount++
              Write-Host "Attempt $retryCount failed. Retrying..."
              Start-Sleep -Seconds 10
            }
          }
          
          if (-not $success) {
            Write-Warning "Failed to update definitions after $maxRetries attempts. Proceeding with existing definitions."
          }
        shell: powershell
        continue-on-error: true

      - name: Scan repository
        id: scan
        run: |
          $logFile = "clamscan-results.txt"
          Write-Host "Starting malware scan..."
          clamscan -r --bell -i --exclude-dir="\.git|\.github|node_modules" . 2>&1 | Tee-Object -FilePath $logFile -Variable output
          $exitCode = $LASTEXITCODE
          
          Write-Host "Scan completed with exit code: $exitCode"
          
          if ($exitCode -eq 1) {
            Write-Error "‚ö†Ô∏è MALWARE DETECTED! Check the scan results above."
            echo "malware_detected=true" >> $env:GITHUB_ENV
            exit 1
          }
          elseif ($exitCode -eq 0) {
            Write-Host "‚úÖ No threats detected"
            echo "malware_detected=false" >> $env:GITHUB_ENV
          }
          else {
            Write-Warning "Scan completed with warnings (exit code: $exitCode)"
            echo "malware_detected=unknown" >> $env:GITHUB_ENV
          }
        shell: powershell

      - name: Upload scan results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: malware-scan-results
          path: clamscan-results.txt
          retention-days: 30
          if-no-files-found: ignore

      - name: Comment on PR with scan result
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const malwareDetected = process.env.malware_detected
            const status =
              malwareDetected === 'true'
                ? '‚ö†Ô∏è **Malware detected!**'
                : malwareDetected === 'false'
                ? '‚úÖ **No threats detected.**'
                : '‚öôÔ∏è **Scan completed with warnings.**'

            const body = `### üß™ Malware Scan Results
            ${status}
            
            You can download detailed logs from the workflow artifacts.`
            
            await github.rest.issues.createComment({
              issue_number: context.payload.pull_request.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body
            })
