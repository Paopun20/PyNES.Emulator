name: "Malware Detection"

on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [main, dev]
  release:
    types: [published]
  workflow_dispatch: {}

jobs:
  detect:
    runs-on: windows-latest
    permissions:
      contents: read
      pull-requests: write
      security-events: write

    defaults:
      run:
        shell: bash

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed files (PR only)
        if: github.event_name == 'pull_request'
        id: changed-files
        uses: tj-actions/changed-files@v44
        with:
          separator: "|"

      - name: Cache ClamAV Database
        uses: actions/cache@v4
        with:
          path: C:/ProgramData/clamav
          key: clamav-db-${{ runner.os }}
          restore-keys: |
            clamav-db-${{ runner.os }}

      - name: Install ClamAV
        run: |
          echo "Installing ClamAV..."
          choco install clamav -y --no-progress
          refreshenv

          echo "ClamAV installed. Verifying..."
          freshclam --version
          clamscan --version

          DB_DIR="C:/ProgramData/clamav"
          mkdir -p "$DB_DIR"
          icacls "$DB_DIR" /grant Everyone:(OI)(CI)F /T

          # Create freshclam.conf
          cat <<'EOF' > "$DB_DIR/freshclam.conf"
          DatabaseMirror db.us.clamav.net
          DatabaseMirror db.eu.clamav.net
          DatabaseMirror db.jp.clamav.net
          DatabaseMirror database.clamav.net
          DatabaseDirectory C:/ProgramData/clamav
          UpdateLogFile C:/ProgramData/clamav/freshclam.log
          LogFileMaxSize 10M
          LogTime yes
          LogVerbose yes
          EOF
          echo "freshclam.conf created at $DB_DIR/freshclam.conf"

      - name: Update virus definitions
        run: |
          DB_DIR="C:/ProgramData/clamav"
          FRESHCLAM_CONF="$DB_DIR/freshclam.conf"
          MAX_RETRIES=3
          RETRY=0
          SUCCESS=0

          echo "Updating ClamAV virus definitions..."
          while [ $RETRY -lt $MAX_RETRIES ]; do
            RETRY=$((RETRY+1))
            echo "Attempt $RETRY/$MAX_RETRIES..."
            freshclam --config-file="$FRESHCLAM_CONF" --verbose && SUCCESS=1 && break
            echo "Attempt $RETRY failed. Retrying in 10s..."
            sleep 10
          done

          if [ $SUCCESS -eq 1 ]; then
            echo "‚úÖ Virus definitions updated successfully"
          else
            echo "‚ùå Failed to update after $MAX_RETRIES attempts. Using cached definitions."
          fi
        continue-on-error: true

      - name: Scan repository (Full Scan)
        if: github.event_name != 'pull_request'
        timeout-minutes: 30
        id: full-scan
        run: |
          LOG_FILE="clamscan-results.txt"
          echo "üîç Starting FULL repository malware scan..."

          clamscan -r --bell -i \
            --exclude-dir=.git \
            --exclude-dir=.github \
            --exclude-dir=node_modules \
            --exclude-dir=dist \
            --exclude-dir=build \
            --exclude-dir=target \
            --exclude-dir=.venv \
            --exclude-dir=venv \
            --exclude-dir=__pycache__ \
            --exclude-dir=.pytest_cache \
            --max-filesize=50M \
            --max-scansize=100M \
            . 2>&1 | tee "$LOG_FILE"

          EXIT_CODE=${PIPESTATUS[0]}

          if [ $EXIT_CODE -eq 1 ]; then
            echo "malware_detected=true" >> $GITHUB_OUTPUT
            echo "scan_status=failed" >> $GITHUB_OUTPUT
          elif [ $EXIT_CODE -eq 0 ]; then
            echo "malware_detected=false" >> $GITHUB_OUTPUT
            echo "scan_status=success" >> $GITHUB_OUTPUT
          else
            echo "malware_detected=unknown" >> $GITHUB_OUTPUT
            echo "scan_status=warning" >> $GITHUB_OUTPUT
          fi

      - name: Scan changed files (PR only)
        if: github.event_name == 'pull_request'
        timeout-minutes: 10
        id: pr-scan
        run: |
          LOG_FILE="clamscan-results.txt"
          CHANGED_FILES="${{ steps.changed-files.outputs.all_changed_files }}"

          if [ -z "$CHANGED_FILES" ]; then
            echo "malware_detected=false" >> $GITHUB_OUTPUT
            echo "scan_status=success" >> $GITHUB_OUTPUT
            echo "files_scanned=0" >> $GITHUB_OUTPUT
            exit 0
          fi

          IFS='|' read -r -a FILE_LIST <<< "$CHANGED_FILES"
          FILES_TO_SCAN=()
          for f in "${FILE_LIST[@]}"; do
            if [ -f "$f" ]; then
              FILES_TO_SCAN+=("$f")
            fi
          done

          FILE_COUNT=${#FILES_TO_SCAN[@]}
          echo "files_scanned=$FILE_COUNT" >> $GITHUB_OUTPUT

          if [ $FILE_COUNT -eq 0 ]; then
            echo "malware_detected=false" >> $GITHUB_OUTPUT
            echo "scan_status=success" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "üîç Scanning $FILE_COUNT changed files..."
          clamscan --bell -i --max-filesize=50M --max-scansize=100M "${FILES_TO_SCAN[@]}" 2>&1 | tee "$LOG_FILE"
          EXIT_CODE=${PIPESTATUS[0]}

          if [ $EXIT_CODE -eq 1 ]; then
            echo "malware_detected=true" >> $GITHUB_OUTPUT
            echo "scan_status=failed" >> $GITHUB_OUTPUT
          elif [ $EXIT_CODE -eq 0 ]; then
            echo "malware_detected=false" >> $GITHUB_OUTPUT
            echo "scan_status=success" >> $GITHUB_OUTPUT
          else
            echo "malware_detected=unknown" >> $GITHUB_OUTPUT
            echo "scan_status=warning" >> $GITHUB_OUTPUT

      - name: Upload scan results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: malware-scan-results-${{ github.run_id }}
          path: clamscan-results.txt
          retention-days: 30

      - name: Comment on PR with scan result
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });

            const malwareDetected = '${{ steps.pr-scan.outputs.malware_detected || steps.full-scan.outputs.malware_detected }}';
            const scanStatus = '${{ steps.pr-scan.outputs.scan_status || steps.full-scan.outputs.scan_status }}';
            const filesScanned = '${{ steps.pr-scan.outputs.files_scanned || 'N/A' }}';

            const statusMap = {
              true: { emoji: 'üö®', text: '**MALWARE DETECTED!**' },
              false: { emoji: '‚úÖ', text: '**No threats detected**' },
              unknown: { emoji: '‚ö†Ô∏è', text: '**Scan completed with warnings**' }
            };
            const status = statusMap[malwareDetected] || statusMap.unknown;

            const body = `### ${status.emoji} Malware Scan Results

            ${status.text}

            **Scan Type:** ${github.event_name === 'pull_request' ? 'Changed files only (PR)' : 'Full repository'}
            **Files Scanned:** ${filesScanned}
            **Status:** \`${scanStatus}\`
            **Workflow:** [View Run](${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID})
            **Commit:** \`${context.sha.slice(0, 7)}\`

            ${malwareDetected === 'true' ? '‚ö†Ô∏è **DO NOT MERGE** until fixed! Review logs.' : '‚ú® Safe to merge (malware-free).'}
            üìé [Download Logs](${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID})

            ---
            *Powered by ClamAV*`;

            await github.rest.issues.createComment({
              ...context.repo,
              issue_number: context.issue.number,
              body
            });

      - name: ‚ùå Fail if malware detected
        if: ${{ steps.full-scan.outputs.malware_detected == 'true' || steps.pr-scan.outputs.malware_detected == 'true' }}
        run: exit 1

      - name: üìä Scan Summary
        if: always()
        run: |
          echo "::group::Final Summary"
          echo "Event: ${{ github.event_name }}"
          echo "Malware detected: ${{ steps.full-scan.outputs.malware_detected || steps.pr-scan.outputs.malware_detected }}"
          echo "Scan status: ${{ steps.full-scan.outputs.scan_status || steps.pr-scan.outputs.scan_status }}"
          echo "Files scanned: ${{ steps.pr-scan.outputs.files_scanned || 'N/A' }}"
          tail -n 10 clamscan-results.txt || true
          echo "::endgroup::"
